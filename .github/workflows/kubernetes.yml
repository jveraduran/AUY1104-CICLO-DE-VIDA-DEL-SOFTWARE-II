name: Despliegue EKS - Estrategias de Rollout

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      strategy:
        description: 'Estrategia a Ejecutar (Debe ser: rolling-update, recreate, blue-green, o canary)'
        required: true
        type: string
        default: 'rolling-update' # Opciones [rolling-update, recreate, canary, blue-green]
      eks_cluster_name:
        description: 'Nombre del Cluster EKS (duoc-eks-cluster-cli)'
        required: true
        default: 'duoc-eks-cluster-cli'
      aws_region:
        description: 'Regi√≥n de AWS'
        required: true
        default: 'us-east-1'

jobs:
  deploy-strategy:
    runs-on: ubuntu-latest
    permissions:
      contents: read 
    
    steps:
      - name: Checkout C√≥digo
        uses: actions/checkout@v4

      - name: Configurar Credenciales AWS (AK/SK/Token)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ github.event.inputs.aws_region }}

      - name: Configurar Kubectl para EKS
        uses: aws-actions/eks-set-context@v4
        with:
          cluster-name: ${{ github.event.inputs.eks_cluster_name }}
          aws-region: ${{ github.event.inputs.aws_region }}
      
      # -----------------------------------------------------------
      # 2.1. üîÑ ROLLING UPDATE (Comportamiento por defecto de K8s)
      # -----------------------------------------------------------
      - name: üîÑ Ejecutar Rolling Update (Default)
        # La condici√≥n se mantiene. Ahora compara el string que el usuario ingres√≥.
        if: ${{ github.event.inputs.strategy == 'rolling-update' }}
        run: |
          echo "Aplicando YAML para Rolling Update (Actualizaci√≥n gradual)..."
          kubectl apply -f [K8S-YAML-PATH]
          kubectl rollout status deployment/duoc-app-rolling --timeout=300s
          echo "‚úÖ Rolling Update completado."

      # -----------------------------------------------------------
      # 2.2. ‚ùå RECREATE (All-in-once)
      # -----------------------------------------------------------
      - name: ‚ùå Ejecutar Recreate (All-in-once)
        if: ${{ github.event.inputs.strategy == 'recreate' }}
        run: |
          echo "Aplicando YAML para Recreate (All-in-once)..."
          kubectl apply -f [K8S-YAML-PATH]
          kubectl rollout status deployment/duoc-app-recreate --timeout=300s
          echo "‚úÖ Recreate completado."
          
      # -----------------------------------------------------------
      # 2.3. üü¶ BLUE/GREEN (Switch at√≥mico con Patch)
      # -----------------------------------------------------------
      - name: üü¶ Ejecutar Blue/Green (kubectl patch)
        if: ${{ github.event.inputs.strategy == 'blue-green' }}
        run: |
          DEPLOYMENT_GREEN_NAME="duoc-app-green"
          SERVICE_NAME="duoc-app-bg-service"
          YAML_FILE_GREEN="[K8S-YAML-PATH]"
          
          echo "1. Desplegando el entorno GREEN (Inactivo)..."
          kubectl apply -f ${{ YAML_FILE_GREEN }}
          kubectl rollout status deployment/${{ DEPLOYMENT_GREEN_NAME }} --timeout=300s
          echo "‚úÖ Rollout de GREEN completado."
          
          echo "2. Ventana de Prueba/Observaci√≥n (120 segundos)..."
          sleep 120
          echo "‚úÖ Prueba simulada completada."
          
          echo "3. Ejecutando el Switch de tr√°fico: BLUE -> GREEN..."
          kubectl patch service ${{ SERVICE_NAME }} -p '{"spec": {"selector": {"version": "green"}}}'
          echo "‚úÖ Switch de tr√°fico completado."
          
      # -----------------------------------------------------------
      # 2.4. üê• CANARY (Promoci√≥n con Scale)
      # -----------------------------------------------------------
      - name: üê• Ejecutar Canary (kubectl scale)
        if: ${{ github.event.inputs.strategy == 'canary' }}
        run: |
          DEPLOYMENT_CANARY_NAME="duoc-app-canary-v2"
          STABLE_DEPLOYMENT_NAME="duoc-app-stable-v1"
          YAML_FILE_CANARY="[K8S-YAML-PATH]"
          TOTAL_REPLICAS=3 # Aseg√∫rate que este sea el n√∫mero total de r√©plicas
          
          echo "1. Desplegando el entorno CANARY (10% de tr√°fico)..."
          kubectl apply -f ${{ YAML_FILE_CANARY }}
          kubectl rollout status deployment/${{ DEPLOYMENT_CANARY_NAME }} --timeout=300s
          echo "‚úÖ Rollout de CANARY inicial completado."
          
          echo "2. Ventana de Prueba/Observaci√≥n (120 segundos)..."
          sleep 120
          echo "‚úÖ Prueba simulada completada."
          
          echo "3. PROMOCI√ìN: Escalar V2 a $TOTAL_REPLICAS y V1 a 0..."
          kubectl scale deployment/${{ DEPLOYMENT_CANARY_NAME }} --replicas=${{ TOTAL_REPLICAS }}
          kubectl scale deployment/${{ STABLE_DEPLOYMENT_NAME }} --replicas=0
          
          echo "4. Esperando el Rollout de Promoci√≥n (V2)..."
          kubectl rollout status deployment/${{ DEPLOYMENT_CANARY_NAME }} --timeout=300s
          echo "‚úÖ Promoci√≥n Canary completada."