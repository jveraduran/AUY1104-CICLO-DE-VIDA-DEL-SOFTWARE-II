name: ECR Build & Push

# üí° Activador: El flujo se ejecutar√° cuando haya un PUSH (incluyendo MERGE)
# a master, O cuando se PUBLIQUE un nuevo Release.
on:
  push:
    branches:
      - master
  release:
    types: [published]

jobs:
  build-and-push:
    name: Build, Tag and Push to ECR
    runs-on: ubuntu-latest
    
    # üí° Definimos las variables de entorno del job.
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

    steps:
      # Pre-requisito para usar 'docker/build-push-action'
      - name: ‚¨áÔ∏è Checkout del C√≥digo
        uses: actions/checkout@v4
        
      # 1. Configurar QEMU (requerido para Docker BuildX)
      - name: ‚öôÔ∏è Configurar QEMU
        uses: docker/setup-qemu-action@v3
        
      # 2. Configurar Buildx (requerido para usar el nuevo builder, habilita la cach√©)
      - name: ‚öôÔ∏è Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Configurar credenciales de AWS
      - name: üîë Configurar Credenciales AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }} 

      # 4. Login en ECR
      - name: üö™ Login en Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      # 5. Build, Tag y Push de Imagen AHORA CON CACH√â DE CAPAS
      - name: üê≥ Build, tag, and push image to ECR with layer caching
        uses: docker/build-push-action@v5
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          
          # El tag 'latest' se usar√° como fuente de cach√©
          CACHE_IMAGE_URI: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          
          # Determinar el tag para el nuevo build (SHA o Release Tag)
          NEW_IMAGE_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || github.sha }}

        with:
          context: . # El directorio para el build (directorio ra√≠z)
          push: true # Habilitar el push a ECR
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.NEW_IMAGE_TAG }}
          
          # üí° USAR IMAGEN PREVIA EN ECR COMO FUENTE DE CACH√â
          # Si las capas de node_modules o dependencias no han cambiado, Docker no las reconstruir√°.
          cache-from: type=registry,ref=${{ env.CACHE_IMAGE_URI }}
          cache-to: type=inline # Guardar metadata de cach√© en la imagen

      - name: üìù Log de Imagen Publicada
        run: echo "La imagen ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.NEW_IMAGE_TAG }} ha sido publicada exitosamente."