name: Build and Test (Optimized)
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  Build_Test:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout del CÃ³digo
        uses: actions/checkout@v4

      # 1. âš¡ OptimizaciÃ³n: Cache de Dependencias
      # Guarda y restaura las dependencias de NPM para evitar descargas repetidas.
      - name: ğŸ’¾ Restaurar CachÃ© de Node Modules
        uses: actions/cache@v4
        id: npm-cache 
        with:
          path: ~/.npm # Ruta de la cachÃ© de NPM en el runner
          # La llave (key) debe cambiar si el archivo package-lock.json cambia
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 2. ConfiguraciÃ³n de Node.js
      - name: âš™ï¸ Configurar Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. InstalaciÃ³n de Dependencias (solo si la cachÃ© fallÃ³)
      # Este paso solo correrÃ¡ si el cachÃ© no fue encontrado (cache-hit != true).
      - name: ğŸ“¦ Instalar Dependencias (npm ci)
        # La condiciÃ³n 'if' verifica si la cachÃ© fue una falta (miss)
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci
      
      # 4. AuditorÃ­a y Pruebas (Solo en PR)
      - name: ğŸ”’ Verificar Compliance (Solo en PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: npm audit

      - name: ğŸ§ª Ejecutar Pruebas Automatizadas (Unidad/IntegraciÃ³n)
        if: ${{ github.event_name == 'pull_request' }}
        run: npm test