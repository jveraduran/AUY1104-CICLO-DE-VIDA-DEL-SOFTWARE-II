name: Build and Test (Optimized)
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, reopened, synchronize] # Activadores para CI

jobs:
  Build_Test:
    runs-on: ubuntu-latest
    steps:
      - name: 猬锔 Checkout del C贸digo
        uses: actions/checkout@v4

      # 1. 锔 Configuraci贸n de Node.js v20 con Cach茅 Integrada
      # Usamos el par谩metro 'cache: npm' en 'setup-node' para la mejor optimizaci贸n.
      # Esto maneja autom谩ticamente las carpetas de cach茅 (~/.npm) basado en package-lock.json.
      - name: 锔 Configurar Node.js v20 con Cach茅
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' 
          
      # 2.  Instalaci贸n de Dependencias 
      # npm ci siempre debe correr. Si la cach茅 se restaur贸, este paso es instant谩neo.
      - name:  Instalar Dependencias (npm ci)
        run: npm ci
      
      # 3.  Auditor铆a y Pruebas (Solo en PR)
      # Estos pasos solo se ejecutan si el evento es un Pull Request.
      - name:  Verificar Compliance (Solo en PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: npm audit

      - name: И Ejecutar Pruebas Automatizadas (Unidad/Integraci贸n)
        if: ${{ github.event_name == 'pull_request' }}
        run: npm test